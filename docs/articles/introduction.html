<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> • MuSiC2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="">
<meta property="og:description" content="MuSiC2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MuSiC2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/introduction.html">Tutorial</a>
</li>
<li>
  <a href="../reference/index.html">Function</a>
</li>
<li>
  <a href="../articles/data.html">Data</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Jiaxin-Fan/MuSiC2/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="introduction_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>MuSiC2: cell type deconvolution for multi-condition bulk RNA-seq data</h1>
                        <h4 class="author">Jiaxin Fan (<a href="mailto:jiaxinf@pennmedicine.upenn.edu" class="email">jiaxinf@pennmedicine.upenn.edu</a>)</h4>
                        
      
      <small class="dont-index">Source: <a href="https://github.com/Jiaxin-Fan/MuSiC2/blob/master/vignettes/introduction.Rmd"><code>vignettes/introduction.Rmd</code></a></small>
      <div class="hidden name"><code>introduction.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<hr>
<p>This vignette provides a walk through tutorial on how to use MuSiC2 to estimate cell type proportions for bulk RNA-seq data using scRNA-seq data as reference when the bulk and scRNA-seq data are generated from samples with multiple clinical conditions.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># install devtools if necessary</span>
<span class="kw">if</span> (!<span class="st">"devtools"</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span>())) {
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">'devtools'</span>)
}
<span class="co"># install the MuSiC2 package</span>
<span class="kw">if</span> (!<span class="st">"MuSiC2"</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span>())) {
  <span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html">install_github</a></span>(<span class="st">'Jiaxin-Fan/MuSiC2'</span>)
}
<span class="co"># load</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">MuSiC2</span>)</pre></body></html></div>
</div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p>Similar as MuSiC (Wang <em>et al</em>., 2019), MuSiC2 uses two types of input data:</p>
<ul>
<li><p>Bulk RNA sequencing expression data collected from samples with 2 different clincial conditions, e.g., healthy and diseased. These are the data we want to deconvolve.</p></li>
<li><p>Single-cell RNA sequencing (scRNA-seq) expression data collected from samples with single condition, e.g., healthy. The cell types of scRNA-seq are pre-determined. These serve as the reference for estimating cell type proportions of the bulk data.</p></li>
</ul>
<p>Both datasets should be in the form of <code>ExpressionSet</code>. The details of constructing <code>ExpressionSet</code> can be found on <a href="https://www.bioconductor.org/packages/release/bioc/vignettes/Biobase/inst/doc/ExpressionSetIntroduction.pdf">this page</a>.</p>
</div>
</div>
<div id="music2-deconvolution" class="section level1">
<h1 class="hasAnchor">
<a href="#music2-deconvolution" class="anchor"></a>MuSiC2 Deconvolution</h1>
<hr>
<p>MuSiC2 is an iterative algorithm aiming to improve cell type deconvolution for bulk RNA-seq data when the bulk data and scRNA-seq reference are generated from samples with different clinical conditions. The key idea of MuSiC2 is that, when the bulk samples and single-cell samples are from different clinical conditions, the majority of genes shall still have similar cell-type-specific gene expression pattern between conditions. By removing genes with cell-type-specific differential expression (DE) between conditions from the single-cell reference, MuSiC2 can refine the reference gene list and yield more accurate cell type proportion estimates.</p>
<p>Assuming we want to deconvolve bulk RNA-seq samples generated from both Healthy and Diseased conditions, using scRNA-seq data generated only from the Healthy condition as the reference. MuSiC2 iterates over 2 steps. In Step 1, we use MuSiC (Wang <em>et al</em>. 2019) to infer the cell type proportions of the bulk samples under both conditions by borrowing information from the scRNA-seq data. In Step 2, for samples within each condition, we deconvolve the bulk-level expression over the cell type proportion estimates obtained in Step 1 to infer the cell-type-specific mean expression for each gene and identify cell-type-specific DE genes between conditions. Then, by removing genes with cell-type-specific DE from the scRNA-seq data, we can update the cell type proportion estimates in Step 1 for bulk samples generated under Diseased condition. By alternating between cell type deconvolution (Step 1) and cell-type-specific DE gene detection and removal (Step 2), MuSiC2 gradually refines the list of “stable” genes retained in the scRNA-seq reference and improves the cell type proportion estimation for the diseased samples. An overview of MuSiC2 is shown in Figure 1.</p>
<style>
figure{
  text-align: center;
}
</style>
<figure><p align="center">
<img src="../Figure%201.jpg" title="fig:" style="width:90.0%" alt="Figure 1: Overview of MuSiC2"><figcaption>
Figure 1: Overview of MuSiC2
</figcaption></p>
</figure><p>To test for the cell-type-specific DE genes, a resampling procedure is employed in order to achieve a reliable estimate. Specifically, at each resampling iteration, we generate a subset of samples by random sampling without replacement under each clinical condition, and compute the log fold change of cell-type-specific expression between conditions, <span class="math inline">\(logFC_g^k=\frac{\mu_{g, diseased}^k}{\mu_{g, healthy}^k}\)</span>. We define a statistic <span class="math inline">\(T_g^k\)</span> as the absolute value of the ratio of the mean and standard deviation (SD) of the <span class="math inline">\(logFC_g^k\)</span> over all resamples as a measure of the cell-type-specific DE. Genes with <span class="math inline">\(T_g^k\)</span> in the top 5% for common cell types, i.e., cell types with average proportion ≥ 10%, or in the top 1% for rare cell types, i.e., cell types with average proportion &lt; 10%, are considered as cell-type-specific DE genes. Since fold change is sensitive to genes with low expression, we suggest that genes with bulk-level average sequencing depth &lt; 20 are retained as “stable” genes and excluded from the cell-type-specific DE detection. We further filter the genes by their expression levels in the random samples. Specifically, we compute the mean of <span class="math inline">\(\mu_{g,healthy}^k\)</span> and <span class="math inline">\(\mu_{g,diseased}^k\)</span> over the resamples, and retain genes with cell-type-specific expression in the bottom 5% for samples in both conditions as “stable” genes and exclude them from the cell-type-specific DE detection. See the Methods session of the MuSiC2 manuscript for additional details.</p>
</div>
<div id="sample-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#sample-analysis" class="anchor"></a>Sample Analysis</h1>
<hr>
<p>For illustration purpose, in this tutorial, we deconvolved the benchmark bulk RNA-seq data, which contain raw RNA-seq read counts and sample annotation data for 100 healthy and 100 diseased (i.e., Type 2 diabetes (T2D)) samples simulated based on pancreatic islets scRNA-seq RNA-seq data from Segerstolpe <em>et al</em>. (2016). The procedure for generating the benchmark dataset can be found in the Methods session of the MuSiC2 manuscript. We deconvolved the benchmark bulk RNA-seq data using scRNA-seq data generated from 6 healthy subjects by Segerstolpe <em>et al</em>. (2016). Both datasets can be found on <a href="https://jiaxin-fan.github.io/MuSiC2/pages/data.html">this page</a>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co">## Bulk RNA-seq data</span>
<span class="no">benchmark.eset</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"./data/bulk-eset.rds"</span>)
<span class="no">benchmark.eset</span></pre></body></html></div>
<pre><code>## ExpressionSet (storageMode: lockedEnvironment)
## assayData: 10000 features, 200 samples 
##   element names: exprs 
## protocolData: none
## phenoData
##   sampleNames: 1 10 ... 200 (200 total)
##   varLabels: sampleID group
##   varMetadata: labelDescription
## featureData: none
## experimentData: use 'experimentData(object)'
## Annotation:</code></pre>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># clinical conditions</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">benchmark.eset</span>$<span class="no">group</span>)</pre></body></html></div>
<pre><code>## 
## healthy     t2d 
##     100     100</code></pre>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co">## scRNA-seq data</span>
<span class="no">seger.eset</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"./data/single-eset.rds"</span>)
<span class="no">seger.eset</span></pre></body></html></div>
<pre><code>## ExpressionSet (storageMode: lockedEnvironment)
## assayData: 25453 features, 1097 samples 
##   element names: exprs 
## protocolData: none
## phenoData
##   sampleNames: AZ_A10 AZ_A11 ... HP1509101_P9 (1097 total)
##   varLabels: sampleID SubjectName cellTypeID cellType
##   varMetadata: labelDescription
## featureData: none
## experimentData: use 'experimentData(object)'
## Annotation:</code></pre>
<div id="cell-type-deconvolution" class="section level2">
<h2 class="hasAnchor">
<a href="#cell-type-deconvolution" class="anchor"></a>Cell Type Deconvolution</h2>
<p>The cell type proportions are estimated by the function <code>music2_prop</code>. The essential inputs are:</p>
<ul>
<li>
<code>bulk.eset</code>: ExpressionSet of bulk data;</li>
<li>
<code>sc.eset</code>: ExpressionSet of single cell data;</li>
<li>
<code>condition</code>: character, the phenoData of bulk dataset used for indicating clinical conditions;</li>
<li>
<code>control</code>: character, the clinical condition of bulk samples that is the same as the clinical condition of the single cell samples;</li>
<li>
<code>case</code>: character, the clinical condition of bulk samples that is different from the clinical condition of the single cell samples;</li>
<li>
<code>clusters</code>: character, the phenoData from single cell dataset used as clusters;</li>
<li>
<code>samples</code>: character, the phenoData from single cell dataset used as samples;</li>
<li>
<code>select.ct</code>: vector of cell types. Default is <code>NULL</code>, which uses all cell types provided in the single-cell data;</li>
<li>
<code>n_resample</code>: numeric, number of resamples used for detecting cell-type-specific DE genes. Default is 20;</li>
<li>
<code>sample_prop</code>: numeric, proportion of samples to be randomly sampled without replacement under each clinical condition for each resample. Default is 0.5;</li>
<li>
<code>cutoff_c</code>: numeric, cutoff on the upper quantile of <span class="math inline">\(T_g^k\)</span> statistics for detecting cell-type-specific DE genes for common cell types (i.e., cell type proportion <span class="math inline">\(\ge\)</span> 0.1). Default is 0.05;</li>
<li>
<code>cutoff_r</code>: numeric, cutoff on the upper quantile of <span class="math inline">\(T_g^k\)</span> statistics for detecting cell-type-specific DE genes for rare cell types (i.e., cell type proportion &lt; 0.1). Default is 0.01;</li>
</ul>
<p>The output of <code>music2_prop</code> is a list with elements:</p>
<ul>
<li>
<code>Est.prop</code>: matrix, cell type proportion estimates;</li>
<li>
<code>convergence</code>: logical, whether MuSiC2 converged or not;</li>
<li>
<code>n.iter</code>: numeric, number of iterations;</li>
<li>
<code>DE.genes</code>: vector, cell-type-specific DE genes being removed;</li>
</ul>
<p>For illustration purpose, we constrained our analysis on 6 well-studied cell types: acinar, alpha, beta, delta, ductal and gamma. Figure 2 below showed the estimated cell type proportion of MuSiC2 separated by disease status (e.g., healthy and T2D).</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># music2 deconvolution</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1234</span>)
<span class="no">est.prop</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MuSiC2/man/music2_prop.html">music2_prop</a></span>(<span class="kw">bulk.eset</span> <span class="kw">=</span> <span class="no">benchmark.eset</span>, <span class="kw">sc.eset</span> <span class="kw">=</span> <span class="no">seger.eset</span>, <span class="kw">condition</span><span class="kw">=</span><span class="st">'group'</span>, <span class="kw">control</span><span class="kw">=</span><span class="st">'healthy'</span>,<span class="kw">case</span><span class="kw">=</span><span class="st">'t2d'</span>, <span class="kw">clusters</span> <span class="kw">=</span> <span class="st">'cellType'</span>, <span class="kw">samples</span> <span class="kw">=</span> <span class="st">'sampleID'</span>, <span class="kw">select.ct</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'acinar'</span>,<span class="st">'alpha'</span>,<span class="st">'beta'</span>,<span class="st">'delta'</span>,<span class="st">'ductal'</span>,<span class="st">'gamma'</span>), <span class="kw">n_resample</span><span class="kw">=</span><span class="fl">20</span>, <span class="kw">sample_prop</span><span class="kw">=</span><span class="fl">0.5</span>,<span class="kw">cutoff_c</span><span class="kw">=</span><span class="fl">0.05</span>,<span class="kw">cutoff_r</span><span class="kw">=</span><span class="fl">0.01</span>)$<span class="no">Est.prop</span></pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="introduction_files/figure-html/cell_type_deconvolution_1-1.png" alt="Figure 2: Cell Type Composition. Jitter plots showing estimated cell type proportions of benchmark bulk RNA-seq samples by disease status (healthy and T2D), estimated using MuSiC2 with healthy scRNA-seq data as reference. The medians of cell type proportions across samples is showed by the black horizontal lines." width="576"><p class="caption">
Figure 2: Cell Type Composition. Jitter plots showing estimated cell type proportions of benchmark bulk RNA-seq samples by disease status (healthy and T2D), estimated using MuSiC2 with healthy scRNA-seq data as reference. The medians of cell type proportions across samples is showed by the black horizontal lines.
</p>
</div>
<p>We also deconvolved the benchmark bulk RNA-seq data using MuSiC (Wang <em>et al</em>., 2019), and evaluated the accuracy of both deconvolution methods by comparing the estimated cell type proportions obtained by MuSiC2 and by MuSiC to the true proportions. Below we present the individual-level root mean square error (RMSE) across cell types for the two deconvolution methods separated by disease status (e.g., healthy and T2D) (Figure 3: left). As expected, because MuSiC2 only refines the gene list in the single cell reference when deconvolving bulk samples generated from clinical condition that differs from the single cell data, MuSiC and MuSiC2 had exactly the same performance for healthy samples with estimation bias close to 0. For diseased samples, MuSiC2 improved the estimation accuracy, highlighting the significance of gene selection for deconvolution. Especially for beta cells, MuSiC2 produced much more accurate cell type proportion estimates for diseased bulk samples than MuSiC, which suffered from severe underestimation (Figure 3: right).</p>
<div class="figure" style="text-align: center">
<img src="introduction_files/figure-html/compare-1.png" alt="Figure 3: Estimation Accuracy. We evaluated the performance of MuSiC2 and compared to MuSiC using the benchmark bulk RNA-seq samples with healthy scRNA-seq data as reference. (Left) Boxplots of individual-level root mean square error (RMSE) across cell types separated by disease status (healthy and T2D). (Right) Boxplots of beta cell proportions comparing true proportions with estimated proportions by MuSiC2 and by MuSiC, separated by disease status (healthy and T2D)." width="672"><p class="caption">
Figure 3: Estimation Accuracy. We evaluated the performance of MuSiC2 and compared to MuSiC using the benchmark bulk RNA-seq samples with healthy scRNA-seq data as reference. (Left) Boxplots of individual-level root mean square error (RMSE) across cell types separated by disease status (healthy and T2D). (Right) Boxplots of beta cell proportions comparing true proportions with estimated proportions by MuSiC2 and by MuSiC, separated by disease status (healthy and T2D).
</p>
</div>
</div>
</div>
<div id="reference" class="section level1">
<h1 class="hasAnchor">
<a href="#reference" class="anchor"></a>Reference</h1>
<hr>
<p>Wang, X., Park, J., Susztak, K., Zhang, N.R., and Li, M. 2019. “Bulk Tissue Cell Type Deconvolution with Multi-Subject Single-Cell Expression Reference.” <em>Nature Communications</em> 10: 380.</p>
<p>Segerstolpe, Å., Palasantza, A., Eliasson, P., Andersson, E.M., Andréasson, A.C., et al. 2016. “Single-cell Transcriptome Profiling of Human Pancreatic Islets in Health and Type 2 Diabetes.” <em>Cell metabolism</em>. 24: 593-607.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jiaxin Fan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
